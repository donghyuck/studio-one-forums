<?xml version="1.0" encoding="UTF-8"?>
<sqlset name="forums" namespace="forums" description="Forums SQLs">
    <sql id="topicList">
        <dynamic><![CDATA[
        select ${selectClause}
        from tb_topics t
        where t.forum_id = :forumId
        <#if searchClause?? && searchClause?length gt 0>
        ${searchClause}
        </#if>
        <#if orderClause?? && orderClause?length gt 0>
        ${orderClause}
        </#if>
        limit :limit offset :offset
        ]]></dynamic>
    </sql>
    <sql id="forumInsert">
        <![CDATA[
        insert into tb_forums
            (slug, name, description, created_by_id, created_by, created_at, updated_by_id, updated_by, updated_at, version)
        values
            (:slug, :name, :description, :createdById, :createdBy, :createdAt, :updatedById, :updatedBy, :updatedAt, :version)
        ]]>
    </sql>
    <sql id="forumUpdate">
        <![CDATA[
        update tb_forums
           set name = :name,
               description = :description,
               updated_by_id = :updatedById,
               updated_by = :updatedBy,
               updated_at = :updatedAt,
               version = version + 1
         where id = :id
           and version = :version
        ]]>
    </sql>
    <sql id="forumSelectById">
        <![CDATA[
        select id, slug, name, description, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at, version
          from tb_forums
         where id = :id
        ]]>
    </sql>
    <sql id="forumSelectBySlug">
        <![CDATA[
        select id, slug, name, description, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at, version
          from tb_forums
         where slug = :slug
        ]]>
    </sql>
    <sql id="forumSelectAll">
        <![CDATA[
        select id, slug, name, description, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at, version
          from tb_forums
         order by updated_at desc, id desc
        ]]>
    </sql>
    <sql id="forumExistsBySlug">
        <![CDATA[
        select count(1)
          from tb_forums
         where slug = :slug
        ]]>
    </sql>
    <sql id="categoryInsert">
        <![CDATA[
        insert into tb_categories
            (forum_id, name, description, position, created_by_id, created_by, created_at, updated_by_id, updated_by, updated_at, version)
        values
            (:forumId, :name, :description, :position, :createdById, :createdBy, :createdAt, :updatedById, :updatedBy, :updatedAt, :version)
        ]]>
    </sql>
    <sql id="categoryUpdate">
        <![CDATA[
        update tb_categories
           set name = :name,
               description = :description,
               position = :position,
               updated_by_id = :updatedById,
               updated_by = :updatedBy,
               updated_at = :updatedAt
         where id = :id
        ]]>
    </sql>
    <sql id="categorySelectById">
        <![CDATA[
        select id, forum_id, name, description, position, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at
          from tb_categories
         where id = :id
        ]]>
    </sql>
    <sql id="categorySelectByForum">
        <![CDATA[
        select id, forum_id, name, description, position, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at
          from tb_categories
         where forum_id = :forumId
         order by position asc, id asc
        ]]>
    </sql>
    <sql id="topicInsert">
        <![CDATA[
        insert into tb_topics
            (forum_id, category_id, title, tags, status, created_by_id, created_by, created_at,
             updated_by_id, updated_by, updated_at, version)
        values
            (:forumId, :categoryId, :title, :tags, :status, :createdById, :createdBy, :createdAt,
             :updatedById, :updatedBy, :updatedAt, :version)
        ]]>
    </sql>
    <sql id="topicUpdate">
        <![CDATA[
        update tb_topics
           set title = :title,
               tags = :tags,
               status = :status,
               updated_by_id = :updatedById,
               updated_by = :updatedBy,
               updated_at = :updatedAt,
               version = version + 1
         where id = :id
           and version = :version
        ]]>
    </sql>
    <sql id="topicSelectById">
        <![CDATA[
        select id, forum_id, category_id, title, tags, status, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at, version
          from tb_topics
         where id = :id
        ]]>
    </sql>
    <sql id="postInsert">
        <![CDATA[
        insert into tb_posts
            (topic_id, content, created_by_id, created_by, created_at, updated_by_id, updated_by, updated_at, version)
        values
            (:topicId, :content, :createdById, :createdBy, :createdAt, :updatedById, :updatedBy, :updatedAt, :version)
        ]]>
    </sql>
    <sql id="postUpdate">
        <![CDATA[
        update tb_posts
           set content = :content,
               updated_by_id = :updatedById,
               updated_by = :updatedBy,
               updated_at = :updatedAt
         where id = :id
        ]]>
    </sql>
    <sql id="postSelectByTopic">
        <![CDATA[
        select id, topic_id, content, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at
          from tb_posts
         where topic_id = :topicId
         order by created_at asc
        ]]>
    </sql>
    <sql id="postList">
        <dynamic><![CDATA[
        select p.id as post_id, p.content, p.created_by_id, p.created_by, p.created_at
        from tb_posts p
        where p.topic_id = :topicId
        <#if orderClause?? && orderClause?length gt 0>
        ${orderClause}
        </#if>
        limit :limit offset :offset
        ]]></dynamic>
    </sql>
</sqlset>
