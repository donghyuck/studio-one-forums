<?xml version="1.0" encoding="UTF-8"?>
<sqlset name="forums" namespace="forums" description="Forums SQLs">
    <sql id="topicList">
        <dynamic><![CDATA[
        select ${selectClause}
        from tb_application_topics t
        where t.forum_id = :forumId
        <#if includeDeleted?? && includeDeleted == false>
        and t.deleted_at is null
        </#if>
        <#if searchClause?? && searchClause?length gt 0>
        ${searchClause}
        </#if>
        <#if orderClause?? && orderClause?length gt 0>
        ${orderClause}
        </#if>
        limit :limit offset :offset
        ]]></dynamic>
    </sql>
    <sql id="forumInsert">
        <![CDATA[
        insert into tb_application_forums
            (slug, name, description, type, created_by_id, created_by, created_at, updated_by_id, updated_by, updated_at, version)
        values
            (:slug, :name, :description, :type, :createdById, :createdBy, :createdAt, :updatedById, :updatedBy, :updatedAt, :version)
        ]]>
    </sql>
    <sql id="forumUpdate">
        <![CDATA[
        update tb_application_forums
           set name = :name,
               description = :description,
               updated_by_id = :updatedById,
               updated_by = :updatedBy,
               updated_at = :updatedAt,
               version = version + 1
         where id = :id
           and version = :version
        ]]>
    </sql>
    <sql id="forumSelectById">
        <![CDATA[
        select id, slug, name, description, type, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at, version
          from tb_application_forums
         where id = :id
        ]]>
    </sql>
    <sql id="forumSelectBySlug">
        <![CDATA[
        select id, slug, name, description, type, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at, version
          from tb_application_forums
         where slug = :slug
        ]]>
    </sql>
    <sql id="forumSelectAll">
        <![CDATA[
        select id, slug, name, description, type, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at, version
          from tb_application_forums
         order by updated_at desc, id desc
        ]]>
    </sql>
    <sql id="forumList">
        <dynamic><![CDATA[
        select id, slug, name, description, type, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at, version
          from tb_application_forums f
         where 1 = 1
        <#if searchClause?? && searchClause?length gt 0>
        ${searchClause}
        </#if>
        <#if orderClause?? && orderClause?length gt 0>
        ${orderClause}
        </#if>
        limit :limit offset :offset
        ]]></dynamic>
    </sql>
    <sql id="forumListVisible">
        <dynamic><![CDATA[
        select id, slug, name, description, type, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at, version
          from tb_application_forums f
         where 1 = 1
        <#if searchClause?? && searchClause?length gt 0>
        ${searchClause}
        </#if>
        <#if visibilityClause?? && visibilityClause?length gt 0>
        ${visibilityClause}
        </#if>
        <#if orderClause?? && orderClause?length gt 0>
        ${orderClause}
        </#if>
        ]]></dynamic>
    </sql>
    <sql id="forumCount">
        <dynamic><![CDATA[
        select count(1)
          from tb_application_forums f
         where 1 = 1
        <#if searchClause?? && searchClause?length gt 0>
        ${searchClause}
        </#if>
        ]]></dynamic>
    </sql>
    <sql id="forumExistsBySlug">
        <![CDATA[
        select count(1)
          from tb_application_forums
         where slug = :slug
        ]]>
    </sql>
    <sql id="forumPropertySelectByForumId">
        <![CDATA[
        select property_name, property_value
          from tb_application_forum_property
         where forum_id = :forumId
         order by property_name asc
        ]]>
    </sql>
    <sql id="forumPropertyDeleteByForumId">
        <![CDATA[
        delete from tb_application_forum_property
         where forum_id = :forumId
        ]]>
    </sql>
    <sql id="forumPropertyInsert">
        <![CDATA[
        insert into tb_application_forum_property
            (forum_id, property_name, property_value)
        values
            (:forumId, :propertyName, :propertyValue)
        ]]>
    </sql>
    <sql id="categoryInsert">
        <![CDATA[
        insert into tb_application_categories
            (forum_id, name, description, position, created_by_id, created_by, created_at, updated_by_id, updated_by, updated_at, version)
        values
            (:forumId, :name, :description, :position, :createdById, :createdBy, :createdAt, :updatedById, :updatedBy, :updatedAt, :version)
        ]]>
    </sql>
    <sql id="categoryUpdate">
        <![CDATA[
        update tb_application_categories
           set name = :name,
               description = :description,
               position = :position,
               updated_by_id = :updatedById,
               updated_by = :updatedBy,
               updated_at = :updatedAt
         where id = :id
        ]]>
    </sql>
    <sql id="categorySelectById">
        <![CDATA[
        select id, forum_id, name, description, position, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at
          from tb_application_categories
         where id = :id
        ]]>
    </sql>
    <sql id="categorySelectByForum">
        <![CDATA[
        select id, forum_id, name, description, position, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at
          from tb_application_categories
         where forum_id = :forumId
         order by position asc, id asc
        ]]>
    </sql>
    <sql id="categoryDelete">
        <![CDATA[
        delete from tb_application_categories
         where id = :id
        ]]>
    </sql>
    <sql id="topicInsert">
        <![CDATA[
        insert into tb_application_topics
            (forum_id, category_id, title, tags, status, pinned, locked, created_by_id, created_by, created_at,
             updated_by_id, updated_by, updated_at, deleted_at, deleted_by_id, version)
        values
            (:forumId, :categoryId, :title, :tags, :status, :pinned, :locked, :createdById, :createdBy, :createdAt,
             :updatedById, :updatedBy, :updatedAt, :deletedAt, :deletedById, :version)
        ]]>
    </sql>
    <sql id="topicUpdate">
        <![CDATA[
        update tb_application_topics
           set title = :title,
               tags = :tags,
               status = :status,
               pinned = :pinned,
               locked = :locked,
               updated_by_id = :updatedById,
               updated_by = :updatedBy,
               updated_at = :updatedAt,
               deleted_at = :deletedAt,
               deleted_by_id = :deletedById,
               version = version + 1
         where id = :id
           and version = :version
        ]]>
    </sql>
    <sql id="topicSelectById">
        <![CDATA[
        select id, forum_id, category_id, title, tags, status, pinned, locked,
               created_by_id, created_by, created_at, updated_by_id, updated_by, updated_at,
               deleted_at, deleted_by_id, version
          from tb_application_topics
         where id = :id
        ]]>
    </sql>
    <sql id="postInsert">
        <![CDATA[
        insert into tb_application_posts
            (topic_id, content, created_by_id, created_by, created_at, updated_by_id, updated_by, updated_at,
             deleted_at, deleted_by_id, hidden_at, hidden_by_id, version)
        values
            (:topicId, :content, :createdById, :createdBy, :createdAt, :updatedById, :updatedBy, :updatedAt,
             :deletedAt, :deletedById, :hiddenAt, :hiddenById, :version)
        ]]>
    </sql>
    <sql id="postUpdate">
        <![CDATA[
        update tb_application_posts
           set content = :content,
               updated_by_id = :updatedById,
               updated_by = :updatedBy,
               updated_at = :updatedAt,
               deleted_at = :deletedAt,
               deleted_by_id = :deletedById,
               hidden_at = :hiddenAt,
               hidden_by_id = :hiddenById,
               version = version + 1
         where id = :id
           and version = :version
        ]]>
    </sql>
    <sql id="postSelectByTopic">
        <![CDATA[
        select id, topic_id, content, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at, deleted_at, deleted_by_id, hidden_at, hidden_by_id, version
          from tb_application_posts
         where topic_id = :topicId
         order by created_at asc
        ]]>
    </sql>
    <sql id="postSelectById">
        <![CDATA[
        select id, topic_id, content, created_by_id, created_by, created_at,
               updated_by_id, updated_by, updated_at, deleted_at, deleted_by_id, hidden_at, hidden_by_id, version
          from tb_application_posts
         where id = :postId
        ]]>
    </sql>
    <sql id="postList">
        <dynamic><![CDATA[
        select p.id as post_id, p.content, p.created_by_id, p.created_by, p.created_at, p.version
        from tb_application_posts p
        where p.topic_id = :topicId
        <#if includeDeleted?? && includeDeleted == false>
        and p.deleted_at is null
        </#if>
        <#if includeHidden?? && includeHidden == false>
        and p.hidden_at is null
        </#if>
        <#if orderClause?? && orderClause?length gt 0>
        ${orderClause}
        </#if>
        limit :limit offset :offset
        ]]></dynamic>
    </sql>
</sqlset>
